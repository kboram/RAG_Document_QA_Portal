{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">

        <!-- 문서 기본 정보 카드 -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <h3 class="card-title fw-bold">{{ document.title }}</h3>
                <p class="text-muted small mb-1">
                    업로드 시간: {{ document.uploaded_at|date:"Y-m-d H:i" }}
                </p>
                <p class="text-muted small mb-0">
                    파일: {{ document.file.name }}
                </p>
            </div>
        </div>

        <!-- 요약 & 질문 버튼 -->
        <div class="d-flex mb-3 gap-2">
            <form method="post" class="me-2">
                {% csrf_token %}
                <input type="hidden" name="mode" value="summary">
                <button type="submit" class="btn btn-outline-secondary btn-sm">
                    문서 요약 생성
                </button>
            </form>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="mode" value="reset">
                <button type="submit" class="btn btn-outline-warning btn-sm">
                    결과 초기화
                </button>
            </form>
        </div>

        <!-- 문서 요약 결과 -->
        {% if summary_text %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white py-2">
                <strong>문서 요약 (GPT 기반)</strong>
            </div>
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap;">{{ summary_text }}</pre>
            </div>
        </div>
        {% endif %}

        <!-- 문서 기반 질문 (RAG + GPT) -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title fw-bold mb-3">문서 기반 질문하기 (RAG + GPT)</h5>

                <form method="post" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="mode" value="qa">
                    <div class="mb-2">
                        <label for="question" class="form-label small text-muted">
                            이 문서 내용과 관련된 질문을 입력해주세요.
                        </label>
                        <textarea
                            id="question"
                            name="question"
                            rows="3"
                            class="form-control"
                            placeholder="예: 이 문서의 핵심 내용이 뭐야?">{{ question }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        GPT에게 물어보기
                    </button>
                </form>

                {% if llm_answer %}
                <hr>
                <div class="mb-2">
                    <span class="badge bg-success">
                        GPT 답변
                    </span>
                    {% if confidence %}
                        <span class="badge bg-info text-dark ms-1">
                            신뢰도 추정: {{ confidence }}%
                        </span>
                    {% endif %}
                </div>
                <div class="border rounded p-3 bg-light">
                    <pre class="mb-0" style="white-space: pre-wrap;">{{ llm_answer }}</pre>
                </div>
                {% endif %}

                {% if search_results %}
                <div class="mt-3">
                    <h6 class="fw-bold">참고한 문서 청크들</h6>
                    <ul class="list-group small">
                        {% for r in search_results %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <span>순위: {{ r.rank }}</span>
                                <span>유사도 스코어: {{ r.score|floatformat:3 }}</span>
                            </div>
                            <div class="mt-1" style="white-space: pre-wrap;">
                                {{ r.text|truncatechars:400 }}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 질문 히스토리 -->
        {% if history %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong>이 문서에 대한 질문 기록</strong>
            </div>
            <div class="card-body">
                <ul class="list-group mb-3">
                    {% for h in history %}
                    <li class="list-group-item">
                        <div class="small text-muted">
                            {{ h.created_at|date:"Y-m-d H:i" }}
                            {% if h.confidence %}
                                · 신뢰도: {{ h.confidence }}%
                            {% endif %}
                        </div>
                        <div class="mt-1"><strong>Q.</strong> {{ h.question }}</div>
                        <div class="mt-1"><strong>A.</strong> {{ h.answer|linebreaksbr }}</div>

                        <!-- 다시 질문하기 버튼 -->
                        <form method="post" class="mt-2">
                            {% csrf_token %}
                            <input type="hidden" name="mode" value="qa">
                            <input type="hidden" name="question" value="{{ h.question }}">
                            <button type="submit" class="btn btn-outline-secondary btn-xs btn-sm">
                                ↩ 이 질문 다시 보내기
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- 오른쪽: 원문 일부 미리보기 -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <strong>문서 내용 미리보기</strong>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if document.content %}
                    <pre style="white-space: pre-wrap;">{{ document.content|truncatechars:3000 }}</pre>
                {% else %}
                    <p class="text-muted small">이 문서에는 저장된 텍스트 내용이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
